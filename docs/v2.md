# Workflow V2 语法文档

## 步骤定义

```javascript
{
  id: string,
  action: string,
  each: boolean,
  input: any,
  ref?: {
    [key: string]: string
  }
}
```

## 基础语法

### 单个任务
```javascript
{
  id: 'processUser',
  action: 'processUser',
  each: false,
  input: {
    userId: 12345,
    name: 'placeholder',
    apiKey: 'static-key'
  },
  ref: {
    "userId": "getUser.id",
    "name": "getUser.name"
  }
}
```

### 批量任务
```javascript
{
  id: 'processUsers', 
  action: 'processUser',
  each: true,
  input: [
    {
      userId: 0,
      name: 'placeholder', 
      apiKey: 'static-key'
    }
  ],
  ref: {
    "[]": "getUsers.list",
    "[].userId": "getUsers.list[].id",
    "[].name": "getUsers.list[].name"
  }
}
```

## 引用语法

### 单个任务引用
```javascript
ref: {
  "field": "taskId.path",
  "nested.field": "taskId.nested.path",
  "array[0]": "taskId.items[0]"
}
```

### 批量任务引用

#### 整体数组替换
```javascript
ref: {
  "[]": "taskId.arrayField"
}
```

#### 字段映射
```javascript
ref: {
  "[].field": "taskId.fieldArray[]",
  "[].nested.field": "taskId.data[].nested.field"
}
```

#### 统一值设置
```javascript
ref: {
  "[*].field": "taskId.singleValue"
}
```

#### 特定索引
```javascript
ref: {
  "[0].field": "taskId.firstValue",
  "[1,3,5].field": "taskId.oddValue",
  "[2-4].field": "taskId.rangeValue"
}
```

## 备选引用

使用逗号分隔多个引用，按顺序尝试：

```javascript
ref: {
  "apiUrl": "primary.url,backup.url,default.url",
  "userId": "premium.userId,basic.userId"
}
```

## 完整示例

### 条件分支处理
```javascript
// 检查用户权限
{
  id: 'checkPermission',
  action: 'checkUserRole', 
  each: false,
  input: {
    userId: 0
  },
  ref: {
    "userId": "getUser.id"
  }
}

// 处理管理员
{
  id: 'processAdmin',
  action: 'processAdminTask',
  each: false, 
  input: {
    userId: 0,
    hasPermission: false
  },
  ref: {
    "userId": "getUser.id",
    "hasPermission": "checkPermission.admin"
  }
}

// 处理普通用户
{
  id: 'processUser',
  action: 'processUserTask',
  each: false,
  input: {
    userId: 0,
    hasPermission: false  
  },
  ref: {
    "userId": "getUser.id",
    "hasPermission": "checkPermission.user"
  }
}

// 汇聚结果
{
  id: 'mergeResult',
  action: 'mergeResults',
  each: false,
  input: {
    result: null
  },
  ref: {
    "result": "processAdmin.result,processUser.result"
  }
}
```

### 批量数据处理
```javascript
// 获取视频列表
{
  id: 'getVideos',
  action: 'fetchVideoList',
  each: false,
  input: {
    category: 'entertainment'
  }
}

// 批量下载视频
{
  id: 'downloadVideos',
  action: 'downloadVideo', 
  each: true,
  input: [
    {
      url: 'placeholder',
      quality: '720p',
      format: 'mp4',
      retryCount: 3
    }
  ],
  ref: {
    "[]": "getVideos.videos",
    "[].url": "getVideos.videos[].downloadUrl"
  }
}

// 处理特定视频
{
  id: 'processSpecialVideos',
  action: 'processVideo',
  each: true, 
  input: [
    {
      url: 'placeholder',
      quality: '1080p',
      priority: 'normal'
    }
  ],
  ref: {
    "[0-2].url": "getVideos.videos[].hdUrl",
    "[0-2].priority": "high",
    "[3-5].url": "getVideos.videos[].sdUrl", 
    "[*].quality": "getVideos.defaultQuality"
  }
}
```

## 关键特性

### 部分映射
只有在 `ref` 中指定的字段会被替换，其他字段保持 `input` 中的原始值。

### 自动依赖
系统自动从 `ref` 中提取依赖关系，确保正确的执行顺序。

### 类型保持
引用值的类型必须与目标字段兼容。

### 容错机制
备选引用提供自动容错能力，当首选引用失败时自动尝试备选项。 